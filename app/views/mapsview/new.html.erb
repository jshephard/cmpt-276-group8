<style>
  #legend {
    background: #4e5d6c;
    padding: 15px 20px 10px 20px;
    margin: 10px;
  }
  #legend h3 {
    margin-top: 0;
  }
  #legend img {
    vertical-align: middle;
  }
</style>
<script type="text/javascript">
  var map;
  var markers = [];
  function initialize() {
      if(navigator.geolocation) {
          success = function(position) {
              createMap(position.coords.latitude, position.coords.longitude);
          };
          error = function() { createMap(49.2780937,-122.922072); }

          navigator.geolocation.getCurrentPosition(success, error);
      } else {
        createMap(49.2780937,-122.922072);
      }
  }

  function createMap(lat, lng) {
      map = new google.maps.Map(document.getElementById('map'), {
          zoom: 11,
          center: new google.maps.LatLng(lat,lng),
          mapTypeId: google.maps.MapTypeId.ROADMAP
      });

    var iconBase = 'https://maps.google.com/mapfiles/kml/shapes/';
    var icons = {
      Concert: {
        name: 'Concert',
        icon: iconBase + 'parking_lot_maps.png'
      },
      Emergency: {
        name: 'Emergency',
        icon: iconBase + 'library_maps.png'
      },
      LocalEvent: {
        name: 'Local Event',
        icon: iconBase + 'info-i_maps.png'
      }
    };

    function addMarker(feature) {
      var marker = new google.maps.Marker({
        position: feature.position,
        icon: icons[feature.type].icon,
        map: map
      });
      markers.push(marker);
    }

    function clearAndDeleteMarkers() {
      for (var i = 0; i < markers.length; i++) {
        markers[i].setMap(null);
      }
      markers = [];
    }

    var legend = document.getElementById('legend');
    for (var key in icons) {
      var type = icons[key];
      var name = type.name;
      var icon = type.icon;
      var div = document.createElement('div');
      div.innerHTML = '<img src="' + icon + '"> ' + name;
      legend.appendChild(div);
    }
    map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legend);

    google.maps.event.addListener(map, 'idle', function() {
      var bounds = map.getBounds();
      var sw = bounds.getSouthWest();
      var ne = bounds.getNorthEast();

      $.getJSON("<%= events_path %>.json?lat_ne=" + ne.lat() + "&lat_sw=" + sw.lat() + "&long_sw=" + sw.lng() + "&long_ne=" + ne.lng(), function(data) {
        clearAndDeleteMarkers();
        $.each(data, function (key, value) {
          var feature = { position: new google.maps.LatLng(value['Latitude'], value['Longitude']),
            type: 'Concert' };

          addMarker(feature);
        });
      }).fail(function() {
          alert("Error occurred fetching events.");
      });
    });

    //Credits to BenjiZombie @ https://github.com/twbs/bootstrap/issues/2475
    $(window).resize(function () {
      var h = $(window).height(),
          offsetTop = 40; // Calculate the top offset

      $('#map').css('height', (h - offsetTop));
    }).resize();
  }
</script>
<script async defer
  src="https://maps.googleapis.com/maps/api/js?callback=initialize">
</script>

<div id="map"></div>
<div id="legend"><h3>Legend</h3></div>