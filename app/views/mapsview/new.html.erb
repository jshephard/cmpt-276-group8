<style>
    #legend {
        background: #4e5d6c;
        padding: 25px 30px 20px 30px;
        margin: 20px;
    }
    
    #legend h3 {
        margin-top: 0;
    }
    
    #legend img {
        vertical-align: middle;
    }
</style>
<script type="text/javascript">
    var map;
    var markers = [];
    var contentString;

    function initialize() {
        if (navigator.geolocation) {
            success = function (position) {
                createMap(position.coords.latitude, position.coords.longitude);
            };
            error = function () {
                createMap(49.2780937, -122.922072);
            }

            navigator.geolocation.getCurrentPosition(success, error);
        } else {
            createMap(49.2780937, -122.922072);
        }
    }

    function createMap(lat, lng) {
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 11,
            center: new google.maps.LatLng(lat, lng),
            mapTypeId: google.maps.MapTypeId.ROADMAP
        });

        var icons = {
          Concert: {
            name: 'Concert',
            icon: "<%= asset_path 'icons/concertlogo.png' %>"
          },
          Emergency: {
            name: 'Emergency',
            icon:  "<%= asset_path 'icons/emergencylogo.png' %>"
          },
          Other: {
            name: 'Other',
            icon: "<%= asset_path 'icons/otherlogo.png' %>"
          },
          Festival: {
            name: 'Festival',
            icon: "<%= asset_path 'icons/festivallogo.png' %>"
          },
          Market: {
            name: 'Market',
            icon: "<%= asset_path 'icons/marketlogo.png' %>"
          },
          Party: {
            name: 'Party',
            icon: "<%= asset_path 'icons/partylogo.png' %>"
          },
          Expo: {
            name: 'Expo',
            icon: "<%= asset_path 'icons/expologo.png' %>"
          },
          Sporting: {
            name: 'Sporting',
            icon: "<%= asset_path 'icons/sportinglogo.png' %>"
          },
          Charity: {
            name: 'Charity',
            icon: "<%= asset_path 'icons/charity-LLL.png' %>"
          }
        };


        function addMarker(feature) {
            if (markers[feature.id] != null) //Already loaded this event.
                return;

            var infowindow = new google.maps.InfoWindow({
                content: contentString
            });

            var marker = new google.maps.Marker({
                position: feature.position,
                icon: icons[feature.type].icon,
                map: map
            });
            marker.addListener('click', function () {
                infowindow.open(map, marker);
            });
            markers[feature.id] = marker;
        }

        var legend = document.getElementById('legend');
        for (var key in icons) {
            var type = icons[key];
            var name = type.name;
            var icon = type.icon;
            var div = document.createElement('div');
            div.innerHTML = '<img src="' + icon + '"> ' + name;
            legend.appendChild(div);
        }

        map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legend);

        google.maps.event.addListener(map, 'idle', function () {
            var bounds = map.getBounds();
            var sw = bounds.getSouthWest();
            var ne = bounds.getNorthEast();

            var request = {
              lat_ne: ne.lat(),
              lat_sw: sw.lat(),
              long_sw: sw.lng(),
              long_ne: ne.lng()
              //todo: can specify types of events
              //events: ['Concert', ...]
            };

            $.getJSON("<%= events_path %>.json", request, function (data) {
                $.each(data, function (key, value) {
                    contentString =
                        '<h3>'+value['Title']+'</h3>'+
                        'Description: '+value['Description']+
                        '<br>Event Location: '+value['Address']+
                        '<br>Date and Time: '+value['StartDate']+value['StartTime'];

                    var feature = {
                        id: value['id'], position: new google.maps.LatLng(value['Latitude'], value['Longitude']),
                        type: value['Category']
                    };

                    addMarker(feature);
                });
            }).fail(function () {
                alert("Error occurred fetching events.");
            });
        });

        //Credits to BenjiZombie @ https://github.com/twbs/bootstrap/issues/2475
        $(window).resize(function () {
            var h = $(window).height(),
                offsetTop = 40; // Calculate the top offset

            $('#map').css('height', (h - offsetTop));
        }).resize();
    }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?callback=initialize">
</script>

<div id="map"></div>
<div id="legend">
    <h3>Legend</h3></div>